<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPath AI - Smart Academic Planning Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }
        .course-detail {
            display: none;
        }
        .course-detail.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold">StudyPath.AI</span>
                </div>
                <div class="hidden sm:flex items-center space-x-8">
                    <a href="#features" class="text-white hover:text-blue-100">Features</a>
                    <a href="#course-planning" class="text-white hover:text-blue-100">Course Planning</a>
                    <a href="#career-goals" class="text-white hover:text-blue-100">Career Goals</a>
                    <a href="#feedback" class="text-white hover:text-blue-100">Feedback</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="gradient-bg text-white py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl sm:text-6xl font-bold mb-6">
                Redefine Your Learning Path with AI
            </h1>
            <p class="text-xl mb-8 text-blue-100">
                StudyPath.AI leverages cutting-edge Edge AI technology to provide intelligent academic planning tools for university students and hackathon organizers
            </p>
            <div class="flex justify-center gap-4">
                <button onclick="document.getElementById('course-planning').scrollIntoView({behavior: 'smooth'})" 
                        class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50">
                    Start Planning
                </button>
                <button onclick="document.getElementById('career-goals').scrollIntoView({behavior: 'smooth'})"
                        class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-400">
                    Explore Career Goals
                </button>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div id="features" class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-900">Core Features</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-blue-900 mb-4">Smart Course Planning</h3>
                    <p class="text-gray-600">AI-powered personalized course recommendations to help you create the optimal learning path.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-blue-900 mb-4">Career Integration</h3>
                    <p class="text-gray-600">Seamlessly align your academic planning with career development goals.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-blue-900 mb-4">Data Visualization</h3>
                    <p class="text-gray-600">Intuitive charts and graphs to track your progress and achievements.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Planning -->
    <div id="course-planning" class="py-20 bg-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-900">Course Planning</h2>
            
            <!-- Add user input form -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-xl font-semibold text-blue-900 mb-6">Planning Assistant</h3>
                
                <!-- Step indicator -->
                <div class="mb-6">
                    <div class="flex justify-between">
                        <div class="text-sm font-medium text-blue-900">Step <span id="current-step">1</span> of 5</div>
                        <div class="text-sm font-medium text-blue-500">Program Information</div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" id="progress-bar" style="width: 20%"></div>
                    </div>
                </div>
                
                <form id="course-planning-form" class="space-y-6">
                    <!-- Step 1: Program Information -->
                    <div id="step-1" class="step-content">
                        <div class="flex flex-col md:flex-row gap-4 mt-4">
                            <input type="text" id="program-url" placeholder="输入课程网页URL" class="flex-grow px-4 py-2 border rounded-lg">
                            <button id="crawl-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                爬取课程信息
                            </button>
                            <button id="vision-crawl-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                计算机视觉爬取
                            </button>
                        </div>
                        
                        <div class="flex justify-end mt-4">
                            <button 
                                type="button" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                                onclick="nextStep(1)"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Current Semester -->
                    <div id="step-2" class="step-content hidden">
                        <div>
                            <label class="block text-sm font-medium text-blue-900 mb-2">
                                Current Semester
                            </label>
                            <input 
                                type="text" 
                                id="current-semester" 
                                class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="e.g., Fall 2025"
                                required
                            >
                        </div>
                        
                        <div class="flex justify-between mt-4">
                            <button 
                                type="button" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400"
                                onclick="prevStep(2)"
                            >
                                Back
                            </button>
                            <button 
                                type="button" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                                onclick="nextStep(2)"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Current Courses -->
                    <div id="step-3" class="step-content hidden">
                        <div>
                            <label class="block text-sm font-medium text-blue-900 mb-2">
                                Which courses are you taking right now?
                            </label>
                            <textarea 
                                id="current-courses" 
                                class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="e.g., CS101: Introduction to Programming, MATH201: Calculus II"
                                rows="3"
                                required
                            ></textarea>
                        </div>
                        
                        <div class="flex justify-between mt-4">
                            <button 
                                type="button" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400"
                                onclick="prevStep(3)"
                            >
                                Back
                            </button>
                            <button 
                                type="button" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                                onclick="nextStep(3)"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Career Path -->
                    <div id="step-4" class="step-content hidden">
                        <div>
                            <label class="block text-sm font-medium text-blue-900 mb-2">
                                Preferred Career Path
                            </label>
                            <input 
                                type="text" 
                                id="career-path" 
                                class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="e.g., Machine Learning Engineer, Software Developer"
                                required
                            >
                        </div>
                        
                        <div class="flex justify-between mt-4">
                            <button 
                                type="button" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400"
                                onclick="prevStep(4)"
                            >
                                Back
                            </button>
                            <button 
                                type="button" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                                onclick="nextStep(4)"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 5: Requirements -->
                    <div id="step-5" class="step-content hidden">
                        <div>
                            <label class="block text-sm font-medium text-blue-900 mb-2">
                                Requirements
                            </label>
                            <textarea 
                                id="interests" 
                                class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="e.g., I want to graduate earlier, and I want to study AI"
                                rows="3"
                            ></textarea>
                        </div>
                        
                        <div class="flex justify-between mt-4">
                            <button 
                                type="button" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400"
                                onclick="prevStep(5)"
                            >
                                Back
                            </button>
                            <button 
                                type="submit" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                            >
                                Generate Course Plan
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Career Goals -->
    <div id="career-goals" class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-900">Career Goals</h2>
            
            <!-- Add user input form -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h3 class="text-xl font-semibold text-blue-900 mb-6">Career Planning Assistant</h3>
                <form id="career-goals-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-blue-900 mb-2">
                            Educational Background
                        </label>
                        <input 
                            type="text" 
                            id="education" 
                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="e.g., Bachelor's in Computer Science"
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-900 mb-2">
                            Preferred Job Titles
                        </label>
                        <input 
                            type="text" 
                            id="job-titles" 
                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="e.g., Machine Learning Engineer, Data Scientist"
                            required
                        >
                    </div>
                    
                    <button 
                        type="submit" 
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                    >
                        Generate Learning Roadmap
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Feedback -->
    <div id="feedback" class="py-20 bg-gray-100">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-12 text-gray-900">Feedback</h2>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <form id="feedback-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-blue-900 mb-1">Name</label>
                        <input 
                            type="text" 
                            id="feedback-name"
                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Enter your name"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-900 mb-1">Email</label>
                        <input 
                            type="email" 
                            id="feedback-email"
                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Enter your email address"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-900 mb-1">Feedback Type</label>
                        <select 
                            id="feedback-category"
                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option>Feature Suggestion</option>
                            <option>Bug Report</option>
                            <option>User Experience</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-blue-900 mb-1">Message</label>
                        <textarea 
                            id="feedback-message"
                            class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            rows="4" 
                            placeholder="Please describe your feedback or suggestions..."
                            required
                        ></textarea>
                    </div>
                    <div class="flex items-center">
                        <input
                            id="feedback-terms"
                            type="checkbox"
                            class="h-4 w-4 rounded border-blue-300 text-blue-600 focus:ring-blue-500"
                            required
                        >
                        <label for="feedback-terms" class="ml-2 block text-sm text-blue-700">
                            I agree to use this feedback to improve the service
                        </label>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700"
                    >
                        Submit Feedback
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Generate Course Plan Button -->
    <div class="mt-8 flex justify-center">
        <button id="generate-plan-btn" 
                class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
            Generate Course Plan
        </button>
    </div>

    <!-- Footer -->
    <footer class="bg-blue-900 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; 2025 StudyPath.AI. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Step navigation functions
        function nextStep(currentStep) {
            // Validate current step
            if (currentStep === 1) {
                const programUrl = document.getElementById('program-url').value;
                if (!programUrl) {
                    alert('Please enter program information URL');
                    return;
                }
            } else if (currentStep === 2) {
                const currentSemester = document.getElementById('current-semester').value;
                if (!currentSemester) {
                    alert('Please enter current semester');
                    return;
                }
            } else if (currentStep === 3) {
                const currentCourses = document.getElementById('current-courses').value;
                if (!currentCourses) {
                    alert('Please enter your current courses');
                    return;
                }
            } else if (currentStep === 4) {
                const careerPath = document.getElementById('career-path').value;
                if (!careerPath) {
                    alert('Please enter preferred career path');
                    return;
                }
            }
            
            // Hide current step
            document.getElementById(`step-${currentStep}`).classList.add('hidden');
            
            // Show next step
            document.getElementById(`step-${currentStep + 1}`).classList.remove('hidden');
            
            // Update progress
            document.getElementById('current-step').textContent = currentStep + 1;
            document.getElementById('progress-bar').style.width = `${(currentStep + 1) * 20}%`;
            
            // Update step indicator text
            updateStepIndicator(currentStep + 1);
        }
        
        function prevStep(currentStep) {
            // Hide current step
            document.getElementById(`step-${currentStep}`).classList.add('hidden');
            
            // Show previous step
            document.getElementById(`step-${currentStep - 1}`).classList.remove('hidden');
            
            // Update progress
            document.getElementById('current-step').textContent = currentStep - 1;
            document.getElementById('progress-bar').style.width = `${(currentStep - 1) * 20}%`;
            
            // Update step indicator text
            updateStepIndicator(currentStep - 1);
        }
        
        function updateStepIndicator(step) {
            const stepText = document.querySelector('#course-planning .text-blue-500');
            switch(step) {
                case 1:
                    stepText.textContent = 'Program Information';
                    break;
                case 2:
                    stepText.textContent = 'Current Semester';
                    break;
                case 3:
                    stepText.textContent = 'Current Courses';
                    break;
                case 4:
                    stepText.textContent = 'Career Path';
                    break;
                case 5:
                    stepText.textContent = 'Requirements';
                    break;
            }
        }
        
        // Handle course planning form submission
        document.getElementById('course-planning-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const programUrl = document.getElementById('program-url').value;
            const currentSemester = document.getElementById('current-semester').value;
            const currentCourses = document.getElementById('current-courses').value;
            const careerPath = document.getElementById('career-path').value;
            const interests = document.getElementById('interests').value;
            
            // Show loading state
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Generating...';
            submitButton.disabled = true;
            
            // Call API to crawl program URL
            fetch('/api/crawl-program', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: programUrl })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch program information');
                }
                return response.json();
            })
            .then(programData => {
                // Now use the program data to generate a chat message
                const message = `
                    I'm planning my academic journey with the following information:
                    - Current semester: ${currentSemester}
                    - Program: ${programData.title}
                    - Current courses: ${currentCourses}
                    - Career goal: ${careerPath}
                    - Requirements: ${interests}
                    
                    The program includes courses like: ${programData.courses.join(', ')}
                    
                    Can you recommend a course plan for me? Please don't include the courses I'm currently taking in your recommendations for the current semester.
                `;
                
                // Call chat API with the message
                return fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to get AI response');
                }
                return response.json();
            })
            .then(data => {
                // 创建一个新的div来显示响应
                const responseDiv = document.createElement('div');
                responseDiv.className = 'mt-6 p-4 bg-blue-50 rounded-lg';
                
                // 解析AI响应
                const parsedResponse = parseAIResponse(data.response);
                
                // 创建HTML结构
                responseDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-blue-900 mb-4">Your Personalized Course Plan</h3>
                    
                    <!-- 图表容器 -->
                    <div class="mb-6" style="height: 300px;">
                        <canvas id="semesterChart"></canvas>
                    </div>
                    
                    <!-- 学期课程详情 -->
                    <div id="semesterDetails" class="mb-6">
                        ${generateSemesterDetailsHTML(parsedResponse.semesters)}
                    </div>
                    
                    <!-- Additional Recommendations -->
                    ${parsedResponse.additionalRecommendations ? `
                    <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">Additional Recommendations</h4>
                        <div class="text-blue-800">${parsedResponse.additionalRecommendations}</div>
                    </div>` : ''}
                    
                    <!-- 总结 -->
                    <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                        <h4 class="font-semibold text-blue-900 mb-2">Summary</h4>
                        <p class="text-blue-800">${parsedResponse.summary}</p>
                    </div>
                `;
                
                // 找到表单的父元素并在表单后附加响应
                const formElement = document.getElementById('course-planning-form');
                if (formElement && formElement.parentNode) {
                    formElement.parentNode.appendChild(responseDiv);
                }
                
                // 重置按钮状态
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                
                // 滚动到响应
                responseDiv.scrollIntoView({behavior: 'smooth'});
                
                // 初始化图表
                initSemesterChart(parsedResponse.semesters);
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Create an error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-4 p-3 bg-red-100 text-red-700 rounded-lg';
                errorDiv.textContent = 'An error occurred while generating your course plan. Please try again.';
                
                // Find the form's parent and append the error after the form
                const formElement = document.getElementById('course-planning-form');
                if (formElement && formElement.parentNode) {
                    formElement.parentNode.appendChild(errorDiv);
                }
                
                // Reset button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        });
        
        // Handle career goals form submission
        document.getElementById('career-goals-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const education = document.getElementById('education').value;
            const jobTitles = document.getElementById('job-titles').value;
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Analyzing career path...';
            submitButton.disabled = true;
            
            // 显示加载指示器
            let loadingIndicator = document.getElementById('career-loading-indicator');
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'career-loading-indicator';
                loadingIndicator.className = 'text-center py-4';
                loadingIndicator.innerHTML = `
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-blue-600">生成学习路线图中...</p>
                `;
                this.parentNode.appendChild(loadingIndicator);
            } else {
                loadingIndicator.style.display = 'block';
            }
            
            // Create a prompt for Gemini
            const prompt = `Please create a personalized learning roadmap for a student with the following information:
            - Educational Background: ${education}
            - Desired Job Titles: ${jobTitles}
            
            Please provide a detailed month-by-month learning plan with specific skills to develop, courses to take, and milestones to achieve. This is for a student with no prior work experience.
            
            Format your response in Markdown with clear sections for each time period (e.g., "## Months 1-3: Foundational Knowledge").
            Include specific course recommendations with platform names.
            Include project ideas for each phase.
            End with job preparation advice.`;
            
            // Call the backend API
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: prompt })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);
                
                // 隐藏加载指示器
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // 检查是否已存在响应，如果存在则移除
                const existingResponse = document.querySelector('#career-goals .ai-response');
                if (existingResponse) {
                    existingResponse.remove();
                }
                
                // Check if the response contains an error message about API key
                if (data.response && (data.response.includes('API密钥未配置') || data.response.includes('API Connection Issue'))) {
                    // Create a mock learning path response
                    const mockResponse = `
                    # Learning Path Planning

                    Based on your ${education} background and ${jobTitles} career goals, here is a customized learning path:
                    
                    ## Months 1-3: Foundational Knowledge
                    
                    - **Technical Skills**:
                      - Programming Language Basics (Python/JavaScript)
                      - Data Structures and Algorithms
                      - Version Control (Git)
                    
                    - **Recommended Courses**:
                      - "Python Data Structures & Algorithms" - Coursera
                      - "Web Development Fundamentals" - Udemy
                    
                    - **Projects**:
                      - Create a personal portfolio website
                      - Complete 5 programming challenges
                    
                    ## Months 4-6: Professional Skill Development
                    
                    - **Technical Skills**:
                      - Frontend/Backend Frameworks
                      - Database Design
                      - Cloud Services Basics
                    
                    - **Recommended Courses**:
                      - "Full-Stack Web Development" - Udacity
                      - "AWS Cloud Services Introduction" - AWS Training
                    
                    - **Projects**:
                      - Develop a complete web application
                      - Contribute to open-source projects
                    
                    ## Months 7-9: Specialization
                    
                    - **Technical Skills**:
                      - Deep dive into specialized knowledge
                      - System Design
                      - Testing and Deployment
                    
                    - **Recommended Courses**:
                      - "System Design Interview" - Educative
                      - "DevOps Practices" - LinkedIn Learning
                    
                    - **Projects**:
                      - Complete a major project
                      - Prepare for technical interviews
                    
                    ## Job Preparation
                    
                    - Refine resume and LinkedIn profile
                    - Prepare for technical interviews
                    - Attend industry events and job fairs
                    - Look for internship opportunities
                    
                    Good luck with your learning journey!
                    `;
                    
                    // Display the mock response
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'mt-6 bg-white p-6 rounded-xl shadow-md ai-response';
                    responseDiv.innerHTML = `
                        <h3 class="text-xl font-semibold text-blue-900 mb-4">AI-Generated Learning Roadmap</h3>
                        <div class="prose prose-blue max-w-none">${mockResponse.replace(/\n/g, '<br>')}</div>
                    `;
                    
                    // Insert the response after the form
                    this.parentNode.appendChild(responseDiv);
                } else if (data.response) {
                    // Display the AI-generated response
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'mt-6 bg-white p-6 rounded-xl shadow-md ai-response';
                    responseDiv.innerHTML = `
                        <h3 class="text-xl font-semibold text-blue-900 mb-4">AI-Generated Learning Roadmap</h3>
                        <div class="prose prose-blue max-w-none">${data.response.replace(/\n/g, '<br>')}</div>
                    `;
                    
                    // Insert the response after the form
                    this.parentNode.appendChild(responseDiv);
                } else {
                    throw new Error('No valid response received');
                }
                
                // Restore button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                
                // Scroll to the response
                const responseElement = document.querySelector('#career-goals .ai-response');
                if (responseElement) {
                    responseElement.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // 隐藏加载指示器
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // 显示错误消息
                alert('生成学习路线图时出错: ' + error.message + '\n\n请稍后再试。');
                
                // Restore button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        });
        
        // Handle feedback form submission
        document.getElementById('feedback-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('feedback-name').value;
            const email = document.getElementById('feedback-email').value;
            const category = document.getElementById('feedback-category').value;
            const message = document.getElementById('feedback-message').value;
            const agreeTerms = document.getElementById('feedback-terms').checked;
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;
            
            // Call the feedback API
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    email,
                    category,
                    message,
                    agreeTerms
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Feedback response:', data);
                
                // Show success message
                alert('Thank you for your feedback! We appreciate your input.');
                
                // Reset form
                this.reset();
                
                // Restore button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting your feedback. Please try again later.');
                
                // Restore button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        });

        // 解析AI响应
        function parseAIResponse(response) {
            console.log("解析AI响应:", response.substring(0, 500) + "...");
            
            // 初始化结果对象
            const result = {
                semesters: [],
                summary: "",
                additionalRecommendations: ""
            };
            
            // 尝试直接解析课程列表格式
            if (response.includes("Fall 2026") || response.includes("Spring 2026")) {
                return parseSimpleFormat(response);
            }
            
            // 尝试提取学期信息 - 支持多种格式
            // 格式1: ### **Semester Name**
            let semesterRegex = /###\s*\*\*([^*]+)\*\*\s*([\s\S]*?)(?=###\s*\*\*|##\s*Additional|##\s*Summary|$)/g;
            let semesterMatch;
            let foundSemesters = false;
            
            while ((semesterMatch = semesterRegex.exec(response)) !== null) {
                foundSemesters = true;
                const semesterName = semesterMatch[1].trim();
                const semesterContent = semesterMatch[2].trim();
                
                // 提取课程
                const courses = [];
                const courseRegex = /\d+\.\s*\*\*([^*]+)\*\*\s*(?:\(([^)]+)\))?/g;
                let courseMatch;
                
                while ((courseMatch = courseRegex.exec(semesterContent)) !== null) {
                    const courseName = courseMatch[1].trim();
                    const courseCode = courseMatch[2] ? courseMatch[2].trim() : "";
                    
                    // 提取课程描述
                    const descriptionRegex = new RegExp(`\\*\\*${courseName.replace(/([.*+?^=!:${}()|[\]\/\\])/g, '\\$1')}\\*\\*(?:\\([^)]+\\))?\\s*-\\s*([^\\n]+)`, 'i');
                    const descriptionMatch = semesterContent.match(descriptionRegex);
                    const description = descriptionMatch ? descriptionMatch[1].trim() : "";
                    
                    // 提取学分信息 - 改进的学分提取
                    let credits = 3; // 默认学分
                    // 先尝试匹配 "X credits" 格式
                    const creditsRegex = /-\s*(\d+)\s*credits/i;
                    const creditsMatch = semesterContent.match(creditsRegex);
                    if (creditsMatch) {
                        credits = parseInt(creditsMatch[1]);
                    } else {
                        // 尝试匹配课程行中的学分信息
                        const lineRegex = new RegExp(`\\*\\*${courseName.replace(/([.*+?^=!:${}()|[\]\/\\])/g, '\\$1')}\\*\\*(?:\\([^)]+\\))?.*?(\\d+)\\s*credits`, 'i');
                        const lineMatch = semesterContent.match(lineRegex);
                        if (lineMatch) {
                            credits = parseInt(lineMatch[1]);
                        } else {
                            credits = estimateCredits(courseCode, courseName);
                        }
                    }
                    
                    courses.push({
                        name: courseName,
                        code: courseCode,
                        description: description,
                        credits: credits
                    });
                }
                
                // 只添加实际学期，不添加"Additional Recommendations"
                if (!semesterName.includes("Additional")) {
                    result.semesters.push({
                        name: semesterName,
                        courses: courses,
                        totalCredits: courses.reduce((sum, course) => sum + course.credits, 0)
                    });
                }
            }
            
            // 如果没有找到学期信息，尝试其他格式
            // 格式2: ## Spring 2025
            if (!foundSemesters) {
                semesterRegex = /##\s*([^#]+?)(?:\s*\(\d+\s*credits\))?\s*([\s\S]*?)(?=##|$)/g;
                
                while ((semesterMatch = semesterRegex.exec(response)) !== null) {
                    const semesterName = semesterMatch[1].trim();
                    const semesterContent = semesterMatch[2].trim();
                    
                    // 跳过非学期部分
                    if (semesterName.toLowerCase().includes("summary") || 
                        semesterName.toLowerCase().includes("additional") ||
                        semesterName.toLowerCase().includes("recommendation")) {
                        continue;
                    }
                    
                    // 提取课程
                    const courses = [];
                    // 尝试匹配不同的课程格式
                    const coursePatterns = [
                        /\*\*([^*]+?)\*\*\s*\(([^)]+)\)\s*-\s*(\d+)\s*credits/g,  // **Course Name** (CODE) - 3 credits
                        /(\d+)\.\s*([^(]+?)\s*\(([^)]+)\)\s*-\s*(\d+)\s*credits/g, // 1. Course Name (CODE) - 3 credits
                        /\*\*([^*]+?)\*\*\s*\(([^)]+)\)/g,  // **Course Name** (CODE)
                        /(\d+)\.\s*([^(]+?)\s*\(([^)]+)\)/g, // 1. Course Name (CODE)
                        /(\d+)\.\s*([^(]+?)\s*-\s*(\d+)\s*credits/g, // 1. Course Name - 3 credits
                        /([^(]+?)\s*\(([^)]+)\)\s*-\s*(\d+)\s*credits/g // Course Name (CODE) - 3 credits
                    ];
                    
                    for (const pattern of coursePatterns) {
                        let courseMatch;
                        while ((courseMatch = pattern.exec(semesterContent)) !== null) {
                            let courseName, courseCode, credits;
                            
                            if (pattern.toString().includes("credits")) {
                                // 格式包含学分信息
                                if (courseMatch.length === 4) {
                                    // **Course Name** (CODE) - 3 credits
                                    courseName = courseMatch[1].trim();
                                    courseCode = courseMatch[2].trim();
                                    credits = parseInt(courseMatch[3]);
                                } else if (courseMatch.length === 5) {
                                    // 1. Course Name (CODE) - 3 credits
                                    courseName = courseMatch[2].trim();
                                    courseCode = courseMatch[3].trim();
                                    credits = parseInt(courseMatch[4]);
                                } else if (courseMatch.length === 3 && !pattern.toString().includes("\\(")) {
                                    // 1. Course Name - 3 credits (没有课程代码)
                                    courseName = courseMatch[1].trim();
                                    courseCode = "";
                                    credits = parseInt(courseMatch[2]);
                                } else {
                                    // Course Name (CODE) - 3 credits
                                    courseName = courseMatch[1].trim();
                                    courseCode = courseMatch[2].trim();
                                    credits = parseInt(courseMatch[3]);
                                }
                            } else {
                                // 格式不包含学分信息
                                if (courseMatch.length === 3) {
                                    // **Course Name** (CODE)
                                    courseName = courseMatch[1].trim();
                                    courseCode = courseMatch[2].trim();
                                } else {
                                    // 1. Course Name (CODE)
                                    courseName = courseMatch[2].trim();
                                    courseCode = courseMatch[3].trim();
                                }
                                credits = estimateCredits(courseCode, courseName);
                            }
                            
                            courses.push({
                                name: courseName,
                                code: courseCode,
                                description: "",  // 描述可能不可用
                                credits: credits
                            });
                        }
                        
                        // 如果找到了课程，不再尝试其他模式
                        if (courses.length > 0) {
                            break;
                        }
                    }
                    
                    result.semesters.push({
                        name: semesterName,
                        courses: courses,
                        totalCredits: courses.reduce((sum, course) => sum + course.credits, 0)
                    });
                }
            }
            
            // 如果仍然没有找到学期信息，创建一个默认学期
            if (result.semesters.length === 0) {
                // 尝试从文本中提取学期名称
                const semesterNameMatch = response.match(/(?:Spring|Fall|Summer|Winter)\s+\d{4}/i);
                const semesterName = semesterNameMatch ? semesterNameMatch[0] : "Spring 2025";
                
                result.semesters.push({
                    name: semesterName,
                    courses: [],
                    totalCredits: 0
                });
            }
            
            // 提取Additional Recommendations部分
            const additionalRegex = /##\s*Additional\s*Recommendations([\s\S]*?)(?=##|$)/i;
            const additionalMatch = response.match(additionalRegex);
            if (additionalMatch) {
                result.additionalRecommendations = additionalMatch[1].trim();
            }
            
            // 提取总结或使用最后一段
            const summaryRegex = /##\s*Summary([\s\S]*?)(?=##|$)/i;
            const summaryMatch = response.match(summaryRegex);
            if (summaryMatch) {
                result.summary = summaryMatch[1].trim();
            } else {
                // 如果没有找到"Summary"部分，使用最后一段作为总结
                const paragraphs = response.split('\n\n');
                if (paragraphs.length > 0) {
                    result.summary = paragraphs[paragraphs.length - 1].trim();
                }
            }
            
            console.log("解析结果:", result);
            return result;
        }
        
        // 简单格式解析函数
        function parseSimpleFormat(response) {
            console.log("使用简单格式解析");
            
            const result = {
                semesters: [],
                summary: "",
                additionalRecommendations: ""
            };
            
            // 提取学期名称
            const semesterNames = [];
            const semesterPattern = /(?:Spring|Fall|Summer|Winter)\s+\d{4}/g;
            let match;
            while ((match = semesterPattern.exec(response)) !== null) {
                if (!semesterNames.includes(match[0])) {
                    semesterNames.push(match[0]);
                }
            }
            
            console.log("找到的学期:", semesterNames);
            
            // 为每个学期创建一个对象
            semesterNames.forEach(name => {
                // 查找该学期的课程
                const semesterSection = response.split(name)[1];
                if (!semesterSection) return;
                
                // 查找下一个学期的位置
                let endIndex = response.length;
                for (const nextSemester of semesterNames) {
                    if (nextSemester !== name && response.indexOf(nextSemester, response.indexOf(name)) > 0) {
                        const nextIndex = response.indexOf(nextSemester, response.indexOf(name));
                        if (nextIndex < endIndex) {
                            endIndex = nextIndex;
                        }
                    }
                }
                
                // 提取该学期的内容
                const content = response.substring(response.indexOf(name), endIndex);
                console.log(`${name} 内容:`, content.substring(0, 200) + "...");
                
                // 提取课程
                const courses = [];
                const coursePattern = /([A-Z]{2,4}\s*\d{3,4})[:\s-]+([^()\n]+)(?:\((\d+)\s*credits\))?/g;
                let courseMatch;
                
                while ((courseMatch = coursePattern.exec(content)) !== null) {
                    const code = courseMatch[1].trim();
                    const courseName = courseMatch[2].trim();
                    const credits = courseMatch[3] ? parseInt(courseMatch[3]) : 3;
                    
                    courses.push({
                        name: courseName,
                        code: code,
                        description: "",
                        credits: credits
                    });
                }
                
                // 如果没有找到课程，尝试其他模式
                if (courses.length === 0) {
                    // 尝试匹配 "Course Name (CODE) - 3 credits" 格式
                    const altPattern = /([^(]+)\s*\(([A-Z]{2,4}\s*\d{3,4})\)\s*-\s*(\d+)\s*credits/g;
                    while ((courseMatch = altPattern.exec(content)) !== null) {
                        const courseName = courseMatch[1].trim();
                        const code = courseMatch[2].trim();
                        const credits = parseInt(courseMatch[3]);
                        
                        courses.push({
                            name: courseName,
                            code: code,
                            description: "",
                            credits: credits
                        });
                    }
                }
                
                // 添加学期
                result.semesters.push({
                    name: name,
                    courses: courses,
                    totalCredits: courses.reduce((sum, course) => sum + course.credits, 0)
                });
            });
            
            // 提取总结
            const summaryPattern = /Summary[:\s]+([\s\S]+?)(?=(?:Spring|Fall|Summer|Winter)\s+\d{4}|$)/i;
            const summaryMatch = response.match(summaryPattern);
            if (summaryMatch) {
                result.summary = summaryMatch[1].trim();
            } else {
                // 使用最后一段作为总结
                const paragraphs = response.split('\n\n');
                if (paragraphs.length > 0) {
                    result.summary = paragraphs[paragraphs.length - 1].trim();
                }
            }
            
            console.log("简单格式解析结果:", result);
            return result;
        }

        // 估算课程学分
        function estimateCredits(courseCode, courseName) {
            // 如果课程代码包含学分信息，尝试提取
            if (courseCode) {
                const creditsMatch = courseCode.match(/(\d+)\s*credits/i);
                if (creditsMatch) {
                    return parseInt(creditsMatch[1]);
                }
            }
            
            // 根据课程名称估算学分
            if (courseName.toLowerCase().includes("lab")) {
                return 1;
            } else if (courseName.toLowerCase().includes("capstone") || 
                       courseName.toLowerCase().includes("thesis") || 
                       courseName.toLowerCase().includes("project")) {
                return 4;
            } else if (courseName.toLowerCase().includes("advanced") || 
                       courseName.toLowerCase().includes("seminar")) {
                return 3;
            }
            
            // 默认学分
            return 3;
        }

        // 生成学期详情HTML
        function generateSemesterDetailsHTML(semesters) {
            let html = '';
            
            semesters.forEach((semester, index) => {
                const isActive = index === 0 ? 'active' : '';
                
                html += `
                    <div id="semester-${index}" class="course-detail ${isActive} p-3 bg-white rounded-lg shadow-sm">
                        <h4 class="font-semibold text-blue-900 mb-3">${semester.name} (${semester.totalCredits} credits)</h4>
                        <ul class="space-y-3">
                `;
                
                semester.courses.forEach(course => {
                    html += `
                        <li class="border-l-4 border-blue-500 pl-3">
                            <div class="font-medium">${course.name} ${course.code ? `(${course.code})` : ''} - ${course.credits} credits</div>
                            <div class="text-sm text-gray-600">${course.description}</div>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            });
            
            return html;
        }

        // 初始化学期图表
        function initSemesterChart(semesters) {
            const ctx = document.getElementById('semesterChart').getContext('2d');
            
            // 准备数据
            const labels = semesters.map(s => s.name);
            const data = semesters.map(s => s.totalCredits);
            
            // 确保每个学期都有数据，如果没有则设置默认值
            for (let i = 0; i < data.length; i++) {
                if (!data[i] || data[i] === 0) {
                    data[i] = 15; // 默认学分数
                }
            }
            
            const backgroundColors = semesters.map((_, i) => 
                `rgba(${37 + i * 20}, ${99 + i * 10}, ${235 - i * 20}, 0.7)`
            );
            
            // 创建图表
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Credit Hours',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Credit Hours'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Semester'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const courses = semesters[index].courses;
                                    return `Courses: ${courses.map(c => c.name).join(', ')}`;
                                }
                            }
                        }
                    },
                    onClick: function(e, elements) {
                        if (elements && elements.length > 0) {
                            const index = elements[0].index;
                            console.log("点击了图表条形:", index, labels[index]);
                            
                            // 只处理实际学期（不包括额外的两个条目）
                            if (index < semesters.length) {
                                // 显示对应学期的详细信息
                                showSemesterDetail(index);
                            }
                        }
                    }
                }
            });
            
            // 显示指定学期的详情
            function showSemesterDetail(index) {
                console.log("显示学期详情:", index);
                
                // 隐藏所有学期详情
                document.querySelectorAll('.course-detail').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = 'none';
                });
                
                // 显示选中的学期详情
                const selectedSemester = document.getElementById(`semester-${index}`);
                if (selectedSemester) {
                    selectedSemester.classList.add('active');
                    selectedSemester.style.display = 'block';
                    
                    // 更新当前学期显示
                    const currentSemesterElement = document.getElementById('current-semester-display');
                    if (currentSemesterElement) {
                        const credits = semesters[index].totalCredits && semesters[index].totalCredits > 0 ? 
                            semesters[index].totalCredits : 15;
                        currentSemesterElement.textContent = `${semesters[index].name} (${credits} credits)`;
                    }
                }
            }
        }

        // 渲染学期详情
        function renderSemesters(semesters) {
            console.log("渲染学期详情:", semesters);
            
            // 如果没有学期或学期为空，创建一个默认学期
            if (!semesters || semesters.length === 0) {
                console.log("没有找到学期，创建默认学期");
                semesters = [{
                    name: "Spring 2025 (Current Semester)",
                    courses: [
                        { name: "Foundations of Machine Learning", code: "CSCI-GA 2565", credits: 3 },
                        { name: "Big Data", code: "CSCI-GA 3033", credits: 4 },
                        { name: "Computer Vision", code: "CSCI-GA 2271", credits: 3 }
                    ],
                    totalCredits: 10
                }];
            }
            
            // 生成学期详情HTML
            const semesterDetailsHTML = generateSemesterDetailsHTML(semesters);
            
            // 更新学期详情容器
            const semesterDetailsContainer = document.getElementById('semester-details');
            if (semesterDetailsContainer) {
                semesterDetailsContainer.innerHTML = semesterDetailsHTML;
                
                // 确保只有第一个学期详情可见
                document.querySelectorAll('.course-detail').forEach((el, index) => {
                    if (index === 0) {
                        el.classList.add('active');
                        el.style.display = 'block';
                    } else {
                        el.classList.remove('active');
                        el.style.display = 'none';
                    }
                });
            } else {
                console.error("找不到semester-details容器");
            }
            
            // 初始化学期图表
            initSemesterChart(semesters);
            
            // 更新学期选择器
            const semesterSelector = document.getElementById('semester-selector');
            if (semesterSelector) {
                semesterSelector.innerHTML = '';
                
                semesters.forEach((semester, index) => {
                    const button = document.createElement('button');
                    button.className = `px-4 py-2 text-sm font-medium ${index === 0 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'} rounded-md hover:bg-blue-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500`;
                    button.textContent = semester.name;
                    button.onclick = function() {
                        // 更新按钮样式
                        document.querySelectorAll('#semester-selector button').forEach((btn, i) => {
                            if (i === index) {
                                btn.className = 'px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-md hover:bg-blue-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500';
                            } else {
                                btn.className = 'px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-md hover:bg-blue-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500';
                            }
                        });
                        
                        // 显示对应学期详情
                        showSemesterDetail(index);
                    };
                    
                    semesterSelector.appendChild(button);
                });
            } else {
                console.error("找不到semester-selector容器");
            }
            
            // 更新当前学期显示
            const currentSemesterElement = document.getElementById('current-semester-display');
            if (currentSemesterElement && semesters.length > 0) {
                // 确保学分数据正确
                const credits = semesters[0].totalCredits && semesters[0].totalCredits > 0 ? 
                    semesters[0].totalCredits : 15;
                currentSemesterElement.textContent = `${semesters[0].name} (${credits} credits)`;
            }
            
            // 显示指定学期的详情
            function showSemesterDetail(index) {
                console.log("显示学期详情:", index);
                
                // 隐藏所有学期详情
                document.querySelectorAll('.course-detail').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = 'none';
                });
                
                // 显示选中的学期详情
                const selectedSemester = document.getElementById(`semester-${index}`);
                if (selectedSemester) {
                    selectedSemester.classList.add('active');
                    selectedSemester.style.display = 'block';
                    
                    // 更新当前学期显示
                    if (currentSemesterElement) {
                        const credits = semesters[index].totalCredits && semesters[index].totalCredits > 0 ? 
                            semesters[index].totalCredits : 15;
                        currentSemesterElement.textContent = `${semesters[index].name} (${credits} credits)`;
                    }
                }
            }
        }

        // 生成课程计划
        function generateCoursePlan() {
            // 获取表单数据
            const programUrl = document.getElementById('program-url').value;
            const semester = document.getElementById('current-semester').value;
            const careerPath = document.getElementById('career-path').value;
            const currentCourses = document.getElementById('current-courses').value.split(',').map(course => course.trim());
            const requirements = document.getElementById('interests').value;
            
            // 显示加载状态
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('course-plan-container').classList.add('hidden');
            
            // 创建请求数据
            const requestData = {
                program_url: programUrl,
                semester: semester,
                career_path: careerPath,
                current_courses: currentCourses,
                requirements: requirements
            };
            
            console.log("发送请求数据:", requestData);
            
            // 调用API
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    message: `Generate a course plan for a student in ${semester} semester who wants to pursue a career in ${careerPath}. 
                    Their program URL is: ${programUrl}. 
                    Current courses: ${currentCourses.join(', ')}. 
                    Additional requirements: ${requirements}`
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("API响应:", data);
                
                // 隐藏加载状态
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('course-plan-container').classList.remove('hidden');
                
                // 在控制台输出完整的API响应
                console.log("完整API响应:", JSON.stringify(data));
                
                // 直接显示原始响应内容（用于调试）
                const rawResponseDiv = document.createElement('div');
                rawResponseDiv.id = 'raw-response';
                rawResponseDiv.style.display = 'none';
                rawResponseDiv.style.whiteSpace = 'pre-wrap';
                rawResponseDiv.style.overflow = 'auto';
                rawResponseDiv.style.maxHeight = '300px';
                rawResponseDiv.style.border = '1px solid #ccc';
                rawResponseDiv.style.padding = '10px';
                rawResponseDiv.style.marginBottom = '20px';
                rawResponseDiv.style.backgroundColor = '#f5f5f5';
                rawResponseDiv.textContent = data.response || data.error;
                
                // 添加一个切换按钮
                const toggleButton = document.createElement('button');
                toggleButton.textContent = '显示/隐藏原始响应';
                toggleButton.className = 'bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 mb-4';
                toggleButton.onclick = function() {
                    const rawResponse = document.getElementById('raw-response');
                    if (rawResponse.style.display === 'none') {
                        rawResponse.style.display = 'block';
                        this.textContent = '隐藏原始响应';
                    } else {
                        rawResponse.style.display = 'none';
                        this.textContent = '显示原始响应';
                    }
                };
                
                // 将按钮和原始响应添加到页面
                const container = document.getElementById('course-plan-container');
                if (container.querySelector('#raw-response')) {
                    container.removeChild(container.querySelector('#raw-response'));
                }
                if (container.querySelector('#toggle-raw-response')) {
                    container.removeChild(container.querySelector('#toggle-raw-response'));
                }
                
                toggleButton.id = 'toggle-raw-response';
                container.insertBefore(toggleButton, container.firstChild);
                container.insertBefore(rawResponseDiv, container.firstChild.nextSibling);
                
                // 解析AI响应
                const planData = parseAIResponse(data.response || data.error);
                
                // 在控制台输出解析后的数据
                console.log("解析后的计划数据:", JSON.stringify(planData));
                
                // 渲染学期课程
                renderSemesters(planData.semesters);
                
                // 渲染图表
                renderCreditHoursChart(planData.semesters);
                
                // 显示总结
                document.getElementById('plan-summary').innerHTML = planData.summary || 
                    "这个计划确保你在AI/ML领域打下坚实基础，获得实践经验，并建立一个可以向潜在雇主展示的项目组合。";
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('course-plan-container').classList.remove('hidden');
                document.getElementById('plan-summary').textContent = '生成课程计划时出错。请稍后再试。';
            });
        }

        // 渲染学分小时图表
        function renderCreditHoursChart(semesters) {
            // 准备图表数据
            const labels = semesters.map(semester => semester.name);
            const creditData = semesters.map(semester => {
                // 确保学分值有效，如果无效则使用默认值
                const credits = semester.totalCredits;
                return (credits && credits > 0) ? credits : 15; // 默认为15学分
            });
            
            // 添加额外的两个条目
            labels.push('计划背景说明');
            labels.push('重要截止日期');
            creditData.push(12);
            creditData.push(15);
            
            // 获取图表上下文
            const ctx = document.getElementById('credit-hours-chart').getContext('2d');
            
            // 销毁现有图表（如果存在）
            if (window.creditChart) {
                window.creditChart.destroy();
            }
            
            // 创建新图表
            window.creditChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '学分小时',
                        data: creditData,
                        backgroundColor: labels.map((_, index) => {
                            // 前三个学期使用蓝色，后两个使用灰色
                            return index < 3 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(156, 163, 175, 0.8)';
                        }),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 18,
                            title: {
                                display: true,
                                text: '学分小时'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '学期'
                            }
                        }
                    },
                    onClick: function(e, elements) {
                        if (elements && elements.length > 0) {
                            const index = elements[0].index;
                            console.log("点击了图表条形:", index, labels[index]);
                            
                            // 只处理实际学期（不包括额外的两个条目）
                            if (index < semesters.length) {
                                // 显示对应学期的详细信息
                                showSemesterDetail(index);
                            }
                        }
                    }
                }
            });
            
            // 显示指定学期的详情
            function showSemesterDetail(index) {
                console.log("显示学期详情:", index);
                
                // 隐藏所有学期详情
                document.querySelectorAll('.course-detail').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = 'none';
                });
                
                // 显示选中的学期详情
                const selectedSemester = document.getElementById(`semester-${index}`);
                if (selectedSemester) {
                    selectedSemester.classList.add('active');
                    selectedSemester.style.display = 'block';
                    
                    // 更新当前学期显示
                    const currentSemesterElement = document.getElementById('current-semester-display');
                    if (currentSemesterElement) {
                        const credits = semesters[index].totalCredits && semesters[index].totalCredits > 0 ? 
                            semesters[index].totalCredits : 15;
                        currentSemesterElement.textContent = `${semesters[index].name} (${credits} credits)`;
                    }
                }
            }
        }

        // 添加生成课程计划按钮的点击事件
        document.getElementById('generate-plan-btn').addEventListener('click', function() {
            generateCoursePlan();
        });

        // 添加计算机视觉爬虫功能
        document.getElementById('vision-crawl-btn').addEventListener('click', function() {
            const url = document.getElementById('program-url').value;
            if (!url) {
                alert('请输入URL');
                return;
            }
            
            // 显示加载状态
            const resultDiv = document.getElementById('crawl-result');
            resultDiv.innerHTML = '<div class="text-center py-10"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div><p class="mt-4 text-gray-600">使用计算机视觉和OCR技术爬取中，这可能需要一些时间...</p></div>';
            
            // 调用计算机视觉爬虫API
            fetch('/api/vision-crawler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url }),
            })
            .then(response => response.json())
            .then(data => {
                // 显示结果
                let html = '<div class="bg-white p-6 rounded-lg shadow-lg">';
                
                // 添加标题和描述
                html += `<h3 class="text-xl font-bold mb-4">${data.title || '未找到标题'}</h3>`;
                html += `<p class="mb-4">${data.description || '未找到描述'}</p>`;
                
                // 添加课程列表
                if (data.courses && data.courses.length > 0) {
                    html += '<div class="mb-4"><h4 class="font-bold mb-2">课程:</h4><ul class="list-disc pl-5">';
                    data.courses.forEach(course => {
                        html += `<li>${course}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                // 添加学分信息
                if (data.credits) {
                    html += `<div class="mb-4"><h4 class="font-bold mb-2">学分要求:</h4><p>${data.credits}</p></div>`;
                }
                
                // 添加计算机视觉分析信息
                if (data.vision_analysis) {
                    html += '<div class="mb-4 p-3 bg-gray-100 rounded"><h4 class="font-bold mb-2">计算机视觉分析:</h4>';
                    html += `<p>检测到的标题区域: ${data.vision_analysis.title_regions_found}</p>`;
                    html += `<p>检测到的列表元素: ${data.vision_analysis.list_elements_found}</p>`;
                    html += `<p>OCR提取文本长度: ${data.vision_analysis.ocr_text_length}</p>`;
                    html += '</div>';
                }
                
                // 如果有错误，显示错误信息
                if (data.error) {
                    html += `<div class="p-3 bg-red-100 text-red-700 rounded mb-4">错误: ${data.error}</div>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">爬取失败: ${error.message}</div>`;
            });
        });

        // 添加测试按钮
        document.addEventListener('DOMContentLoaded', function() {
            // 创建测试按钮
            const testButton = document.createElement('button');
            testButton.textContent = '本地测试';
            testButton.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500';
            testButton.onclick = testLocalData;
            
            // 添加到页面
            document.body.appendChild(testButton);
        });

        // 本地测试函数
        function testLocalData() {
            console.log("开始本地测试");
            
            // 模拟API响应数据
            const mockResponse = `
# Personalized Course Plan for AI Studies

### **Spring 2025 (Current Semester)**
Total Credits: 15

1. **Introduction to Artificial Intelligence** (CS301) - 3 credits
   - Fundamental concepts of AI, including search algorithms, knowledge representation, and reasoning.

2. **Machine Learning Fundamentals** (CS401) - 4 credits
   - Introduction to machine learning algorithms, supervised and unsupervised learning.

3. **Linear Algebra for AI** (MATH301) - 4 credits
   - Vector spaces, matrices, and linear transformations with applications to AI.

4. **Python Programming for AI** (CS201) - 4 credits
   - Advanced Python programming techniques for AI applications.

### **Fall 2025**
Total Credits: 15

1. **Deep Learning** (CS402) - 4 credits
   - Neural networks, backpropagation, convolutional networks, and recurrent networks.

2. **Natural Language Processing** (CS403) - 3 credits
   - Computational approaches to processing and understanding human language.

3. **Computer Vision** (CS404) - 4 credits
   - Image processing, feature extraction, object recognition, and scene understanding.

4. **AI Ethics and Society** (PHIL301) - 4 credits
   - Ethical considerations in AI development and deployment.

### **Spring 2026**
Total Credits: 14

1. **Reinforcement Learning** (CS501) - 4 credits
   - Learning through interaction with environments, Q-learning, and policy gradients.

2. **AI Capstone Project** (CS502) - 6 credits
   - Comprehensive project applying AI techniques to real-world problems.

3. **AI in Industry** (CS503) - 4 credits
   - Applications of AI in various industries and business contexts.

## Additional Recommendations

### Internships
- Apply for summer internships at tech companies with AI focus
- Consider research assistantships with professors working on AI projects

### Certifications
- TensorFlow Developer Certificate
- AWS Machine Learning Specialty

### Extracurriculars
- Join the university's AI or Machine Learning club
- Participate in Kaggle competitions to build your portfolio

## Summary

This plan ensures you graduate with a strong foundation in AI/ML, practical experience, and a portfolio of projects to showcase to potential employers. Let me know if you'd like further adjustments or additional guidance! 🚀
`;

            // 隐藏加载状态
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('course-plan-container').classList.remove('hidden');
            
            // 解析模拟响应
            const planData = parseAIResponse(mockResponse);
            
            console.log("解析后的数据:", planData);
            
            // 渲染学期课程
            renderSemesters(planData.semesters);
            
            // 渲染图表
            renderCreditHoursChart(planData.semesters);
            
            // 显示总结
            document.getElementById('plan-summary').innerHTML = planData.summary || 
                "这个计划确保你在AI/ML领域打下坚实基础，获得实践经验，并建立一个可以向潜在雇主展示的项目组合。";
        }
    </script>
</body>
</html> 